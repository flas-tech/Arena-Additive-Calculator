<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Arena Dust Control Blend Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f7;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #222;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    p.subheading {
      margin-top: 0;
      color: #555;
      font-size: 0.95rem;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.05);
      padding: 20px;
      margin-top: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #fafafa;
    }
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #0070f3;
      box-shadow: 0 0 0 1px rgba(0,112,243,0.2);
      background: #fff;
    }
    .field {
      margin-bottom: 12px;
    }
    .inline-fields {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: #0070f3;
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
      box-shadow: 0 4px 10px rgba(0, 112, 243, 0.28);
    }
    button:hover {
      background: #005ad1;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 112, 243, 0.3);
    }
    .btn-secondary {
      background: #e4e4e7;
      color: #111827;
      box-shadow: none;
      margin-left: 6px;
    }
    .btn-secondary:hover {
      background: #d4d4d8;
    }
    .error {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 6px;
    }
    .results {
      margin-top: 8px;
    }
    .results h3 {
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 6px;
    }
    .note {
      font-size: 0.85rem;
      color: #555;
      margin-top: 8px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    @media (max-width: 600px) {
      .inline-fields {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Arena Dust Control Blend Calculator</h1>
  <p class="subheading">
    Enter arena dimensions, footing type, and basic lab data. This tool suggests a customized blend
    and exact component volumes for your arena. Formulas are heuristic and intended as R&amp;D starting points.
  </p>

  <div class="card">
    <form id="blendForm">
      <h2>Arena &amp; Footing Inputs</h2>
      <div class="grid">
        <div>
          <div class="field inline-fields">
            <div>
              <label for="lengthFt">Arena length (ft)</label>
              <input type="number" id="lengthFt" min="1" step="0.1" placeholder="e.g. 200" required>
            </div>
            <div>
              <label for="widthFt">Arena width (ft)</label>
              <input type="number" id="widthFt" min="1" step="0.1" placeholder="e.g. 100" required>
            </div>
          </div>
          <div class="field">
            <label for="depthIn">Treatment depth (inches)</label>
            <input type="number" id="depthIn" min="0.5" step="0.1" placeholder="e.g. 2" required>
          </div>
          <div class="field">
            <label for="footingType">Footing type</label>
            <select id="footingType" required>
              <option value="">Select footing type...</option>
              <option value="m10">M10 screenings / crusher dust</option>
              <option value="washed_sand">Washed angular sand</option>
              <option value="sand_fiber">Sand + fiber</option>
              <option value="sand_rubber">Sand + rubber</option>
              <option value="sand_felt">Sand + felt / textile</option>
              <option value="ggt">GGT / high-fiber engineered footing</option>
              <option value="other">Other / custom</option>
            </select>
          </div>
        </div>

        <div>
          <h3>Lab / Field Test Inputs</h3>
          <div class="field inline-fields">
            <div>
              <label for="avgParticleSize">Average particle size (µm)</label>
              <input type="number" id="avgParticleSize" min="1" step="1" placeholder="e.g. 200">
            </div>
            <div>
              <label for="finesPercent">% fines &lt; 75µm</label>
              <input type="number" id="finesPercent" min="0" max="100" step="1" placeholder="e.g. 18">
            </div>
          </div>
          <div class="field inline-fields">
            <div>
              <label for="shearRating">Shear / grip (1–10)</label>
              <input type="number" id="shearRating" min="1" max="10" step="1" placeholder="1=very slick, 10=very grippy">
            </div>
            <div>
              <label for="compressRating">Compressibility (1–10)</label>
              <input type="number" id="compressRating" min="1" max="10" step="1" placeholder="1=very firm, 10=very deep">
            </div>
          </div>
          <div class="field">
            <label for="saltLevel">Existing salt / CaCl₂ level</label>
            <select id="saltLevel">
              <option value="none">None / negligible</option>
              <option value="low">Low (light historical use)</option>
              <option value="medium" selected>Medium (common previous use)</option>
              <option value="high">High (heavily salted)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="field">
        <label for="notes">Optional notes (discipline, indoor/outdoor, issues)</label>
        <textarea id="notes" placeholder="e.g. Indoor hunter/jumper arena, currently very dusty in winter, slightly deep on long side."></textarea>
      </div>

      <button type="submit">Calculate Custom Blend</button>
      <button type="button" class="btn-secondary" id="clearBtn">Clear</button>
      <div id="error" class="error" aria-live="polite"></div>
    </form>
  </div>

  <div class="card results" id="resultsCard" style="display:none;">
    <h2>Recommended Blend &amp; Volumes</h2>
    <div id="summary"></div>

    <h3>Component Breakdown <span class="badge">Prototype</span></h3>
    <table>
      <thead>
      <tr>
        <th>Component</th>
        <th>Role</th>
        <th>Blend %</th>
        <th>Volume (gal)</th>
      </tr>
      </thead>
      <tbody id="componentTableBody"></tbody>
    </table>

    <div class="note" id="doseNote"></div>

    <h3>Technical Notes</h3>
    <div class="note" id="technicalNotes"></div>
  </div>

  <div class="card">
    <h2>About the Model</h2>
    <p class="note">
      This calculator uses a simple heuristic model:
      it estimates dust severity and footing sensitivity from footing type, % fines,
      shear, compressibility, and salt history. It then:
    </p>
    <ul class="note">
      <li>Sets a total fluid dose (gallons / ft²) in the range ~0.006–0.012 gal/ft².</li>
      <li>Splits the dose between:
        <strong>Base Oil Blend</strong> (primary dust suppression),
        <strong>Conditioning Ester</strong> (flow / wetting),
        and optional <strong>Polymer Stabilizer</strong> (light binding for very loose, high-fines footing).</li>
      <li>Outputs exact volumes for your arena dimensions and treatment depth.</li>
    </ul>
    <p class="note">
      All values are intended as development starting points only; adjust with real-world riding and lab feedback.
    </p>
  </div>
</div>

<script>
  // Main calculation logic

  function clamp(value, min, max, fallback = null) {
    if (value === null || isNaN(value)) return fallback !== null ? fallback : min;
    return Math.min(max, Math.max(min, value));
  }

  function estimateDustSeverity(footingType, finesPercent, avgParticleSize) {
    // Return a number in [1,3] (1 = low, 3 = high)
    let base;
    switch (footingType) {
      case "m10":
        base = 3; // very fine, high dust potential
        break;
      case "washed_sand":
        base = 1.5;
        break;
      case "sand_fiber":
      case "sand_felt":
      case "ggt":
        base = 2.0;
        break;
      case "sand_rubber":
        base = 1.8;
        break;
      default:
        base = 2.0;
    }

    if (!isNaN(finesPercent)) {
      if (finesPercent > 20) base += 0.5;
      else if (finesPercent < 10) base -= 0.3;
    }

    if (!isNaN(avgParticleSize)) {
      if (avgParticleSize < 150) base += 0.3;  // very fine
      else if (avgParticleSize > 300) base -= 0.2; // coarser sand
    }

    return clamp(base, 1, 3);
  }

  function estimateFootingSensitivity(compressRating, shearRating) {
    // Higher means more sensitive to over-stiffening (avoid polymer, heavy dosing)
    // compressRating: 1=very firm, 10=very deep
    // shearRating: 1=slick, 10=grippy
    let comp = clamp(compressRating, 1, 10, 5);
    let shear = clamp(shearRating, 1, 10, 5);

    // Deep (high compress) footing is sensitive to extra "weight" and polymer.
    let sensitivity = 0;
    sensitivity += (comp - 5) * 0.15; // deep -> positive
    sensitivity -= (shear - 5) * 0.05; // very grippy can tolerate a bit more

    return clamp(1.5 + sensitivity, 1, 3); // 1=robust, 3=very sensitive
  }

  function estimateSaltAdjustment(saltLevel) {
    // Slightly reduce dose where salt is already present
    switch (saltLevel) {
      case "high": return -0.15;
      case "medium": return -0.07;
      case "low": return -0.03;
      default: return 0;
    }
  }

  function calculateTotalDoseGalPerFt2(dustSeverity, sensitivity) {
    // Base dose: 0.006–0.012 gal/ft²
    // Higher dust severity → higher dose
    let baseDose = 0.006 + (dustSeverity - 1) * (0.006 / 2); // ~0.006, 0.009, 0.012

    // More sensitive footing → slightly lower dose
    if (sensitivity > 2.2) {
      baseDose *= 0.9;
    } else if (sensitivity < 1.8) {
      baseDose *= 1.05;
    }

    return baseDose;
  }

  function calculateBlendRatios(footingType, dustSeverity, sensitivity) {
    // Determine % for:
    //  - Base Oil Blend
    //  - Conditioning Ester
    //  - Polymer Stabilizer
    let oil = 65;
    let ester = 25;
    let polymer = 10;

    // For M10, we like a bit more oil and some polymer
    if (footingType === "m10") {
      oil = 70;
      ester = 20;
      polymer = 10;
    }

    // High dust severity but low sensitivity: allow more polymer
    if (dustSeverity > 2.5 && sensitivity < 2) {
      polymer += 5;
      oil -= 2;
      ester -= 3;
    }

    // Very sensitive, deep footing: back off polymer and reduce heaviness
    if (sensitivity > 2.4) {
      polymer = Math.max(0, polymer - 7);
      ester += 3;
      oil += 4;
    }

    // Normalization
    const total = oil + ester + polymer;
    return {
      oil: (oil / total) * 100,
      ester: (ester / total) * 100,
      polymer: (polymer / total) * 100
    };
  }

  function formatNumber(num, decimals) {
    return num.toLocaleString(undefined, {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  }

  document.getElementById("blendForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const errorDiv = document.getElementById("error");
    errorDiv.textContent = "";

    const lengthFt = parseFloat(document.getElementById("lengthFt").value);
    const widthFt = parseFloat(document.getElementById("widthFt").value);
    const depthIn = parseFloat(document.getElementById("depthIn").value);
    const footingType = document.getElementById("footingType").value;

    if (!lengthFt || !widthFt || !depthIn || !footingType) {
      errorDiv.textContent = "Please fill in arena length, width, depth, and footing type.";
      return;
    }

    const avgParticleSize = parseFloat(document.getElementById("avgParticleSize").value);
    const finesPercent = parseFloat(document.getElementById("finesPercent").value);
    const shearRating = parseFloat(document.getElementById("shearRating").value);
    const compressRating = parseFloat(document.getElementById("compressRating").value);
    const saltLevel = document.getElementById("saltLevel").value;
    const notes = document.getElementById("notes").value.trim();

    // Geometry
    const areaFt2 = lengthFt * widthFt;
    const depthFt = depthIn / 12;

    const dustSeverity = estimateDustSeverity(footingType, finesPercent, avgParticleSize);
    const sensitivity = estimateFootingSensitivity(compressRating, shearRating);
    const saltAdj = estimateSaltAdjustment(saltLevel);

    let dosePerFt2 = calculateTotalDoseGalPerFt2(dustSeverity, sensitivity);
    dosePerFt2 *= (1 + saltAdj);

    // Keep dose in a reasonable range
    dosePerFt2 = clamp(dosePerFt2, 0.005, 0.013);

    const totalGallons = dosePerFt2 * areaFt2;

    const ratios = calculateBlendRatios(footingType, dustSeverity, sensitivity);

    const oilGallons = totalGallons * (ratios.oil / 100);
    const esterGallons = totalGallons * (ratios.ester / 100);
    const polymerGallons = totalGallons * (ratios.polymer / 100);

    // Summary text
    const summaryDiv = document.getElementById("summary");
    const footingLabel = document.querySelector("#footingType option:checked").textContent;

    const dustLabel = dustSeverity >= 2.7
      ? "High"
      : dustSeverity >= 1.8
        ? "Moderate"
        : "Low";

    const sensitivityLabel = sensitivity >= 2.4
      ? "High (deep / sensitive to stiffening)"
      : sensitivity <= 1.7
        ? "Low (robust footing)"
        : "Moderate";

    summaryDiv.innerHTML = `
      <p>
        <strong>Arena:</strong> ${formatNumber(lengthFt,1)} ft × ${formatNumber(widthFt,1)} ft
        (${formatNumber(areaFt2,0)} ft²), treated depth ~${formatNumber(depthIn,1)} in.
        <br/>
        <strong>Footing:</strong> ${footingLabel}<br/>
        <strong>Estimated dust severity:</strong> ${dustLabel} (${dustSeverity.toFixed(2)})<br/>
        <strong>Footing sensitivity:</strong> ${sensitivityLabel} (${sensitivity.toFixed(2)})
      </p>
      <p>
        <strong>Total prototype fluid dose:</strong>
        ~${formatNumber(dosePerFt2 * 1000,2)} gal / 1,000 ft²
        &nbsp; (≈ ${formatNumber(totalGallons,1)} gal total for this arena).
      </p>
    `;

    // Component table
    const tbody = document.getElementById("componentTableBody");
    tbody.innerHTML = "";

    const rows = [
      {
        name: "Base Oil Blend",
        role: "Primary dust suppression & particle coating",
        pct: ratios.oil,
        gal: oilGallons
      },
      {
        name: "Conditioning Ester",
        role: "Improved wetting, flow & feel; reduces greasiness",
        pct: ratios.ester,
        gal: esterGallons
      },
      {
        name: "Polymer Stabilizer (optional)",
        role: "Light binding for high-fines / very loose footing",
        pct: ratios.polymer,
        gal: polymerGallons
      }
    ];

    rows.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.name}</td>
        <td>${row.role}</td>
        <td>${formatNumber(row.pct,1)}%</td>
        <td>${formatNumber(row.gal,1)} gal</td>
      `;
      tbody.appendChild(tr);
    });

    const doseNote = document.getElementById("doseNote");
    doseNote.innerHTML = `
      These volumes assume treatment of the top ~${formatNumber(depthIn,1)} in of footing.
      For split applications (e.g., two passes), divide the total gallons accordingly.
      All doses are approximate and should be refined with field testing.
    `;

    const techNotes = document.getElementById("technicalNotes");
    techNotes.innerHTML = `
      • This blend is intended as a non-evaporating, hoof-safe dust control system tailored to your footing profile.<br/>
      • Higher fines and smaller particle sizes increase dust severity and push the model toward higher total dose and some polymer content.<br/>
      • Deep or highly compressible footing increases sensitivity, which reduces total dose and de-emphasizes polymer to avoid over-stiffening.<br/>
      • Existing salt (CaCl₂) slightly reduces the recommended dose; long-term, you can transition away from salts as you add fresh, treated footing.<br/>
      ${notes ? "• User notes: " + notes.replace(/\n/g, " ") : ""}
    `;

    document.getElementById("resultsCard").style.display = "block";
    document.getElementById("resultsCard").scrollIntoView({ behavior: "smooth" });
  });

  document.getElementById("clearBtn").addEventListener("click", function () {
    document.getElementById("blendForm").reset();
    document.getElementById("error").textContent = "";
    document.getElementById("resultsCard").style.display = "none";
  });
</script>
</body>
</html>
