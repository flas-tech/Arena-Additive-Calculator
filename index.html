<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Arena Dust Control Blend Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f7;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #222;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    p.subheading {
      margin-top: 0;
      color: #555;
      font-size: 0.95rem;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.05);
      padding: 20px;
      margin-top: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #fafafa;
    }
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #0070f3;
      box-shadow: 0 0 0 1px rgba(0,112,243,0.2);
      background: #fff;
    }
    .field {
      margin-bottom: 12px;
    }
    .inline-fields {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px;
      background: #e5e7eb;
      margin: 8px 0 12px;
    }
    .mode-toggle button {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }
    .mode-toggle button.active {
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }
    button[type="submit"] {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: #0070f3;
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
      box-shadow: 0 4px 10px rgba(0, 112, 243, 0.28);
    }
    button[type="submit"]:hover {
      background: #005ad1;
    }
    button[type="submit"]:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 112, 243, 0.3);
    }
    .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: #e4e4e7;
      color: #111827;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 8px;
      margin-left: 6px;
      transition: background 0.15s ease;
    }
    .btn-secondary:hover {
      background: #d4d4d8;
    }
    .error {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 6px;
    }
    .results {
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 6px;
    }
    .note {
      font-size: 0.85rem;
      color: #555;
      margin-top: 8px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    @media (max-width: 600px) {
      .inline-fields {
        grid-template-columns: 1fr;
      }
    }
    .pill-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .section-label {
      font-size: 0.88rem;
      font-weight: 600;
      color: #374151;
      margin: 8px 0 4px;
    }
    .pill {
      display: inline-block;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px 10px;
      font-size: 0.78rem;
      color: #374151;
      margin-left: 4px;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Arena Dust Control Blend Calculator</h1>
  <p class="subheading">
    Enter arena dimensions, footing information, and either lab-style inputs or your
    <strong>Arena Footing Test Kit</strong> results to generate a custom dust-control blend and container recommendations.
  </p>

  <div class="card">
    <form id="blendForm">
      <h2>Arena &amp; Footing Inputs</h2>

      <div class="mode-toggle" role="radiogroup" aria-label="Input mode">
        <button type="button" id="modeStandardBtn" class="active" data-mode="standard">Standard Mode</button>
        <button type="button" id="modeKitBtn" data-mode="kit">Kit Mode (Test Kit)</button>
      </div>

      <input type="hidden" id="mode" value="standard">

      <div class="grid">
        <div>
          <div class="field inline-fields">
            <div>
              <label for="lengthFt">Arena length (ft)</label>
              <input type="number" id="lengthFt" min="1" step="0.1" placeholder="e.g. 200" required>
            </div>
            <div>
              <label for="widthFt">Arena width (ft)</label>
              <input type="number" id="widthFt" min="1" step="0.1" placeholder="e.g. 100" required>
            </div>
          </div>
          <div class="field">
            <label for="depthIn">Treatment depth (inches)</label>
            <input type="number" id="depthIn" min="0.5" step="0.1" placeholder="e.g. 2" required>
          </div>
          <div class="field">
            <label for="footingType">Footing type</label>
            <select id="footingType" required>
              <option value="">Select footing type...</option>
              <option value="m10">M10 screenings / crusher dust</option>
              <option value="washed_sand">Washed angular sand</option>
              <option value="sand_fiber">Sand + fiber</option>
              <option value="sand_rubber">Sand + rubber</option>
              <option value="sand_felt">Sand + felt / textile</option>
              <option value="ggt">GGT / high-fiber engineered footing</option>
              <option value="other">Other / custom</option>
            </select>
          </div>
        </div>

        <div id="standardInputs">
          <h3>Standard Lab / Field Inputs</h3>
          <div class="field inline-fields">
            <div>
              <label for="avgParticleSize">Average particle size (µm)</label>
              <input type="number" id="avgParticleSize" min="1" step="1" placeholder="e.g. 200">
            </div>
            <div>
              <label for="finesPercent">% fines &lt; 75µm</label>
              <input type="number" id="finesPercent" min="0" max="100" step="1" placeholder="e.g. 18">
            </div>
          </div>
          <div class="field inline-fields">
            <div>
              <label for="shearRating">Shear / grip (1–10)</label>
              <input type="number" id="shearRating" min="1" max="10" step="1" placeholder="1=very slick, 10=very grippy">
            </div>
            <div>
              <label for="compressRating">Compressibility (1–10)</label>
              <input type="number" id="compressRating" min="1" max="10" step="1" placeholder="1=very firm, 10=very deep">
            </div>
          </div>
          <div class="field">
            <label for="saltLevel">Existing salt / CaCl₂ level</label>
            <select id="saltLevel">
              <option value="none">None / negligible</option>
              <option value="low">Low (light historical use)</option>
              <option value="medium" selected>Medium (common previous use)</option>
              <option value="high">High (heavily salted)</option>
            </select>
          </div>
        </div>

        <div id="kitInputs" style="display:none;">
          <h3>Kit Mode Inputs (from Arena Footing Test Kit)</h3>

          <div class="section-label">
            Test 1 – Sieve Weights <span class="pill">Use 100 g sample</span>
          </div>
          <div class="field inline-fields">
            <div>
              <label for="coarseWeight">Coarse sieve weight (g)</label>
              <input type="number" id="coarseWeight" min="0" step="0.1" placeholder="e.g. 40">
            </div>
            <div>
              <label for="mediumWeight">Medium sieve weight (g)</label>
              <input type="number" id="mediumWeight" min="0" step="0.1" placeholder="e.g. 45">
            </div>
          </div>
          <div class="field">
            <label for="fineWeight">Fine / passing &lt;75µm (g)</label>
            <input type="number" id="fineWeight" min="0" step="0.1" placeholder="e.g. 15">
          </div>

          <div class="section-label">
            Test 2 – Shear / Drag Test
          </div>
          <div class="field inline-fields">
            <div>
              <label for="drag1">Pull force 1 (lb)</label>
              <input type="number" id="drag1" min="0" step="0.1" placeholder="e.g. 8">
            </div>
            <div>
              <label for="drag2">Pull force 2 (lb)</label>
              <input type="number" id="drag2" min="0" step="0.1">
            </div>
          </div>
          <div class="field">
            <label for="drag3">Pull force 3 (lb)</label>
            <input type="number" id="drag3" min="0" step="0.1">
          </div>

          <div class="section-label">
            Test 3 – Compressibility / Depth
          </div>
          <div class="field inline-fields">
            <div>
              <label for="depth1">Sink depth 1 (in)</label>
              <input type="number" id="depth1" min="0" step="0.1" placeholder="e.g. 1.2">
            </div>
            <div>
              <label for="depth2">Sink depth 2 (in)</label>
              <input type="number" id="depth2" min="0" step="0.1">
            </div>
          </div>
          <div class="field">
            <label for="depth3">Sink depth 3 (in)</label>
            <input type="number" id="depth3" min="0" step="0.1">
          </div>

          <div class="section-label">
            Test 4 – EC / Salt Level
          </div>
          <div class="field">
            <label for="kitSaltBand">Salt level band (from strip color chart)</label>
            <select id="kitSaltBand">
              <option value="none">None / very low</option>
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
      </div>

      <div class="field">
        <label for="notes">Optional notes (discipline, indoor/outdoor, issues)</label>
        <textarea id="notes" placeholder="e.g. Indoor hunter/jumper arena, currently very dusty in winter, slightly deep on long side."></textarea>
      </div>

      <button type="submit">Calculate Custom Blend</button>
      <button type="button" class="btn-secondary" id="clearBtn">Clear</button>
      <div id="error" class="error" aria-live="polite"></div>
    </form>
  </div>

  <div class="card results" id="resultsCard" style="display:none;">
    <h2>Recommended Blend &amp; Volumes</h2>
    <div id="summary"></div>

    <h3>Component Breakdown <span class="badge">Prototype</span></h3>
    <table>
      <thead>
      <tr>
        <th>Component</th>
        <th>Role</th>
        <th>Blend %</th>
        <th>Volume (gal)</th>
      </tr>
      </thead>
      <tbody id="componentTableBody"></tbody>
    </table>

    <div class="note" id="doseNote"></div>

    <h3>Container Recommendation <span class="badge">Auto-sized</span></h3>
    <div class="note" id="containerRecommendation"></div>

    <h3>Technical Notes</h3>
    <div class="note" id="technicalNotes"></div>

    <div class="note" id="kitDerivedBlock" style="display:none; margin-top:12px;">
      <strong>Kit-derived internal values:</strong>
      <div id="kitDerivedText"></div>
    </div>
  </div>

  <div class="card">
    <h2>About the Model</h2>
    <p class="note">
      This calculator uses a simple heuristic model:
      it estimates dust severity and footing sensitivity from footing type, fines,
      shear, compressibility, and salt history. It then:
    </p>
    <ul class="note">
      <li>Sets a total fluid dose (gallons / ft²) in the range ~0.006–0.013 gal/ft².</li>
      <li>Splits the dose between:
        <strong>Base Oil Blend</strong> (primary dust suppression),
        <strong>Conditioning Ester</strong> (flow / wetting),
        and optional <strong>Polymer Stabilizer</strong> (light binding for very loose, high-fines footing).</li>
      <li>Automatically recommends container sizes (5-gal pails, 30-gal drums,
        55-gal drums, 275-gal totes) to slightly exceed your calculated total.</li>
    </ul>
    <p class="note">
      All values are intended as development starting points only; refine with real-world riding and lab feedback.
    </p>
  </div>
</div>

<script>
  function clamp(value, min, max, fallback = null) {
    if (value === null || isNaN(value)) return fallback !== null ? fallback : min;
    return Math.min(max, Math.max(min, value));
  }

  function estimateDustSeverity(footingType, finesPercent, avgParticleSize) {
    let base;
    switch (footingType) {
      case "m10":
        base = 3;
        break;
      case "washed_sand":
        base = 1.5;
        break;
      case "sand_fiber":
      case "sand_felt":
      case "ggt":
        base = 2.0;
        break;
      case "sand_rubber":
        base = 1.8;
        break;
      default:
        base = 2.0;
    }

    if (!isNaN(finesPercent)) {
      if (finesPercent > 20) base += 0.5;
      else if (finesPercent < 10) base -= 0.3;
    }

    if (!isNaN(avgParticleSize)) {
      if (avgParticleSize < 150) base += 0.3;
      else if (avgParticleSize > 300) base -= 0.2;
    }

    return clamp(base, 1, 3);
  }

  function estimateFootingSensitivity(compressRating, shearRating) {
    let comp = clamp(compressRating, 1, 10, 5);
    let shear = clamp(shearRating, 1, 10, 5);

    let sensitivity = 0;
    sensitivity += (comp - 5) * 0.15;
    sensitivity -= (shear - 5) * 0.05;

    return clamp(1.5 + sensitivity, 1, 3);
  }

  function estimateSaltAdjustment(saltLevel) {
    switch (saltLevel) {
      case "high": return -0.15;
      case "medium": return -0.07;
      case "low": return -0.03;
      default: return 0;
    }
  }

  function calculateTotalDoseGalPerFt2(dustSeverity, sensitivity) {
    let baseDose = 0.006 + (dustSeverity - 1) * (0.006 / 2); // ~0.006, 0.009, 0.012

    if (sensitivity > 2.2) {
      baseDose *= 0.9;
    } else if (sensitivity < 1.8) {
      baseDose *= 1.05;
    }

    return baseDose;
  }

  function calculateBlendRatios(footingType, dustSeverity, sensitivity) {
    let oil = 65;
    let ester = 25;
    let polymer = 10;

    if (footingType === "m10") {
      oil = 70;
      ester = 20;
      polymer = 10;
    }

    if (dustSeverity > 2.5 && sensitivity < 2) {
      polymer += 5;
      oil -= 2;
      ester -= 3;
    }

    if (sensitivity > 2.4) {
      polymer = Math.max(0, polymer - 7);
      ester += 3;
      oil += 4;
    }

    const total = oil + ester + polymer;
    return {
      oil: (oil / total) * 100,
      ester: (ester / total) * 100,
      polymer: (polymer / total) * 100
    };
  }

  function formatNumber(num, decimals) {
    return num.toLocaleString(undefined, {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  }

  // Map Kit Mode readings to internal values
  function deriveFromKitInputs() {
    // Sieve
    const coarse = parseFloat(document.getElementById("coarseWeight").value) || 0;
    const medium = parseFloat(document.getElementById("mediumWeight").value) || 0;
    const fine = parseFloat(document.getElementById("fineWeight").value) || 0;
    const total = coarse + medium + fine;

    let finesPercent = null;
    let avgParticleSize = null;

    if (total > 0) {
      finesPercent = (fine / total) * 100;

      // Crude weighted average particle size using rough band midpoints
      const dCoarse = 1000; // microns (very rough)
      const dMedium = 300;
      const dFine = 50;

      const avg =
        (coarse * dCoarse + medium * dMedium + fine * dFine) / total;
      avgParticleSize = avg;
    }

    // Shear: based on drag forces
    const d1 = parseFloat(document.getElementById("drag1").value);
    const d2 = parseFloat(document.getElementById("drag2").value);
    const d3 = parseFloat(document.getElementById("drag3").value);
    const dragVals = [d1, d2, d3].filter(v => !isNaN(v) && v > 0);
    let shearRating = null;
    let avgDrag = null;

    if (dragVals.length > 0) {
      avgDrag = dragVals.reduce((a, b) => a + b, 0) / dragVals.length;

      // Map pull force (lb) to 1–10 rating
      if (avgDrag < 5) shearRating = 2;
      else if (avgDrag < 8) shearRating = 4;
      else if (avgDrag < 12) shearRating = 6;
      else if (avgDrag < 16) shearRating = 8;
      else shearRating = 9;
    }

    // Compressibility: sink depth
    const s1 = parseFloat(document.getElementById("depth1").value);
    const s2 = parseFloat(document.getElementById("depth2").value);
    const s3 = parseFloat(document.getElementById("depth3").value);
    const depthVals = [s1, s2, s3].filter(v => !isNaN(v) && v >= 0);
    let compressRating = null;
    let avgDepth = null;

    if (depthVals.length > 0) {
      avgDepth = depthVals.reduce((a, b) => a + b, 0) / depthVals.length;

      if (avgDepth < 0.5) compressRating = 2;
      else if (avgDepth < 1.0) compressRating = 4;
      else if (avgDepth < 1.5) compressRating = 6;
      else if (avgDepth < 2.0) compressRating = 8;
      else compressRating = 9;
    }

    const saltBand = document.getElementById("kitSaltBand").value;
    let saltLevel = saltBand; // directly reuse mapping

    return {
      finesPercent,
      avgParticleSize,
      shearRating,
      compressRating,
      saltLevel,
      avgDrag,
      avgDepth
    };
  }

  // Container recommendation
  function recommendContainers(totalGallons) {
    const containers = [
      { name: "275-gal tote", size: 275 },
      { name: "55-gal drum", size: 55 },
      { name: "30-gal drum", size: 30 },
      { name: "5-gal pail", size: 5 }
    ];

    // Brute force small search over counts to minimize overfill and container count
    let best = null;

    for (let c275 = 0; c275 <= 4; c275++) {
      for (let c55 = 0; c55 <= 10; c55++) {
        for (let c30 = 0; c30 <= 10; c30++) {
          for (let c5 = 0; c5 <= 20; c5++) {
            const volume =
              c275 * 275 + c55 * 55 + c30 * 30 + c5 * 5;
            if (volume <= 0) continue;
            if (volume < totalGallons) continue;

            const overfill = volume - totalGallons;
            const count = c275 + c55 + c30 + c5;

            if (
              !best ||
              overfill < best.overfill ||
              (overfill === best.overfill && count < best.count)
            ) {
              best = {
                overfill,
                count,
                totalVolume: volume,
                c275,
                c55,
                c30,
                c5
              };
            }
          }
        }
      }
    }

    return best;
  }

  // Mode toggle
  const modeInput = document.getElementById("mode");
  const modeStandardBtn = document.getElementById("modeStandardBtn");
  const modeKitBtn = document.getElementById("modeKitBtn");
  const standardInputsDiv = document.getElementById("standardInputs");
  const kitInputsDiv = document.getElementById("kitInputs");

  function setMode(mode) {
    modeInput.value = mode;
    if (mode === "standard") {
      standardInputsDiv.style.display = "block";
      kitInputsDiv.style.display = "none";
      modeStandardBtn.classList.add("active");
      modeKitBtn.classList.remove("active");
    } else {
      standardInputsDiv.style.display = "none";
      kitInputsDiv.style.display = "block";
      modeStandardBtn.classList.remove("active");
      modeKitBtn.classList.add("active");
    }
    // Hide kit-derived block by default until we calculate again
    document.getElementById("kitDerivedBlock").style.display = "none";
  }

  modeStandardBtn.addEventListener("click", () => setMode("standard"));
  modeKitBtn.addEventListener("click", () => setMode("kit"));

  document.getElementById("blendForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const errorDiv = document.getElementById("error");
    errorDiv.textContent = "";

    const mode = modeInput.value || "standard";

    const lengthFt = parseFloat(document.getElementById("lengthFt").value);
    const widthFt = parseFloat(document.getElementById("widthFt").value);
    const depthIn = parseFloat(document.getElementById("depthIn").value);
    const footingType = document.getElementById("footingType").value;

    if (!lengthFt || !widthFt || !depthIn || !footingType) {
      errorDiv.textContent = "Please fill in arena length, width, depth, and footing type.";
      return;
    }

    let avgParticleSize = parseFloat(document.getElementById("avgParticleSize").value);
    let finesPercent = parseFloat(document.getElementById("finesPercent").value);
    let shearRating = parseFloat(document.getElementById("shearRating").value);
    let compressRating = parseFloat(document.getElementById("compressRating").value);
    let saltLevel = document.getElementById("saltLevel").value;

    let kitDerived = null;

    if (mode === "kit") {
      kitDerived = deriveFromKitInputs();
      avgParticleSize = kitDerived.avgParticleSize;
      finesPercent = kitDerived.finesPercent;
      shearRating = kitDerived.shearRating;
      compressRating = kitDerived.compressRating;
      saltLevel = kitDerived.saltLevel;
    }

    // Geometry
    const areaFt2 = lengthFt * widthFt;
    const depthFt = depthIn / 12;

    const dustSeverity = estimateDustSeverity(footingType, finesPercent, avgParticleSize);
    const sensitivity = estimateFootingSensitivity(compressRating, shearRating);
    const saltAdj = estimateSaltAdjustment(saltLevel);

    let dosePerFt2 = calculateTotalDoseGalPerFt2(dustSeverity, sensitivity);
    dosePerFt2 *= (1 + saltAdj);
    dosePerFt2 = clamp(dosePerFt2, 0.005, 0.013);

    const totalGallons = dosePerFt2 * areaFt2;

    const ratios = calculateBlendRatios(footingType, dustSeverity, sensitivity);
    const oilGallons = totalGallons * (ratios.oil / 100);
    const esterGallons = totalGallons * (ratios.ester / 100);
    const polymerGallons = totalGallons * (ratios.polymer / 100);

    const summaryDiv = document.getElementById("summary");
    const footingLabel = document.querySelector("#footingType option:checked").textContent;

    const dustLabel = dustSeverity >= 2.7
      ? "High"
      : dustSeverity >= 1.8
        ? "Moderate"
        : "Low";

    const sensitivityLabel = sensitivity >= 2.4
      ? "High (deep / sensitive to stiffening)"
      : sensitivity <= 1.7
        ? "Low (robust footing)"
        : "Moderate";

    summaryDiv.innerHTML = `
      <p>
        <strong>Mode:</strong> ${mode === "kit" ? "Kit Mode (Arena Footing Test Kit)" : "Standard Mode"}<br/>
        <strong>Arena:</strong> ${formatNumber(lengthFt,1)} ft × ${formatNumber(widthFt,1)} ft
        (${formatNumber(areaFt2,0)} ft²), treated depth ~${formatNumber(depthIn,1)} in.<br/>
        <strong>Footing:</strong> ${footingLabel}<br/>
        <strong>Estimated dust severity:</strong> ${dustLabel} (${dustSeverity.toFixed(2)})<br/>
        <strong>Footing sensitivity:</strong> ${sensitivityLabel} (${sensitivity.toFixed(2)})
      </p>
      <p>
        <strong>Total prototype fluid dose:</strong>
        ~${formatNumber(dosePerFt2 * 1000,2)} gal / 1,000 ft²
        &nbsp; (≈ ${formatNumber(totalGallons,1)} gal total for this arena).
      </p>
    `;

    // Component table
    const tbody = document.getElementById("componentTableBody");
    tbody.innerHTML = "";

    const rows = [
      {
        name: "Base Oil Blend",
        role: "Primary dust suppression & particle coating",
        pct: ratios.oil,
        gal: oilGallons
      },
      {
        name: "Conditioning Ester",
        role: "Improved wetting, flow & feel; reduces greasiness",
        pct: ratios.ester,
        gal: esterGallons
      },
      {
        name: "Polymer Stabilizer (optional)",
        role: "Light binding for high-fines / very loose footing",
        pct: ratios.polymer,
        gal: polymerGallons
      }
    ];

    rows.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.name}</td>
        <td>${row.role}</td>
        <td>${formatNumber(row.pct,1)}%</td>
        <td>${formatNumber(row.gal,1)} gal</td>
      `;
      tbody.appendChild(tr);
    });

    const doseNote = document.getElementById("doseNote");
    doseNote.innerHTML = `
      These volumes assume treatment of the top ~${formatNumber(depthIn,1)} in of footing.
      For split applications (e.g., two passes), divide the total gallons accordingly.
      All doses are approximate and should be refined with field testing.
    `;

    // Container recommendation
    const containerDiv = document.getElementById("containerRecommendation");
    const rec = recommendContainers(totalGallons);

    if (rec) {
      const lines = [];
      if (rec.c275) lines.push(`${rec.c275} × 275-gal tote`);
      if (rec.c55) lines.push(`${rec.c55} × 55-gal drum`);
      if (rec.c30) lines.push(`${rec.c30} × 30-gal drum`);
      if (rec.c5) lines.push(`${rec.c5} × 5-gal pail`);

      const overPct = (rec.overfill / totalGallons) * 100;

      containerDiv.innerHTML = `
        Recommended container mix:<br/>
        <strong>${lines.join(" + ")}</strong><br/>
        Total shipped volume: ~${formatNumber(rec.totalVolume,1)} gal
        (≈ ${formatNumber(rec.overfill,1)} gal over calculated need, ${formatNumber(overPct,1)}% margin).
        <br/><br/>
        This recommendation assumes a pre-blended fluid. If you ship components separately,
        apply the same container plan proportionally to each component.
      `;
    } else {
      containerDiv.textContent = "Unable to compute a suitable container combination. Please review the arena size and try again.";
    }

    const techNotes = document.getElementById("technicalNotes");
    const notes = document.getElementById("notes").value.trim();
    techNotes.innerHTML = `
      • This blend is intended as a non-evaporating, hoof-friendly dust control system tailored to your footing profile.<br/>
      • Higher fines and smaller particle sizes increase dust severity and push the model toward higher total dose and some polymer content.<br/>
      • Deep or highly compressible footing increases sensitivity, which reduces total dose and de-emphasizes polymer to avoid over-stiffening.<br/>
      • Existing salt (CaCl₂) slightly reduces the recommended dose; long-term, you can transition away from salts as you add fresh, treated footing.<br/>
      ${notes ? "• User notes: " + notes.replace(/\n/g, " ") : ""}
    `;

    // Show kit-derived internal values if using kit mode
    const kitBlock = document.getElementById("kitDerivedBlock");
    const kitText = document.getElementById("kitDerivedText");
    if (mode === "kit" && kitDerived) {
      kitBlock.style.display = "block";
      kitText.innerHTML = `
        • Derived % fines &lt;75µm: ${kitDerived.finesPercent != null ? formatNumber(kitDerived.finesPercent,1) + "%" : "n/a"}<br/>
        • Estimated average particle size: ${kitDerived.avgParticleSize != null ? formatNumber(kitDerived.avgParticleSize,0) + " µm" : "n/a"}<br/>
        • Average drag force: ${kitDerived.avgDrag != null ? formatNumber(kitDerived.avgDrag,1) + " lb" : "n/a"} → shear rating ≈ ${kitDerived.shearRating != null ? kitDerived.shearRating : "n/a"}/10<br/>
        • Average sink depth: ${kitDerived.avgDepth != null ? formatNumber(kitDerived.avgDepth,2) + " in" : "n/a"} → compressibility ≈ ${kitDerived.compressRating != null ? kitDerived.compressRating : "n/a"}/10<br/>
        • Salt level band: ${kitDerived.saltLevel || "n/a"}
      `;
    } else {
      kitBlock.style.display = "none";
    }

    document.getElementById("resultsCard").style.display = "block";
    document.getElementById("resultsCard").scrollIntoView({ behavior: "smooth" });
  });

  document.getElementById("clearBtn").addEventListener("click", function () {
    document.getElementById("blendForm").reset();
    document.getElementById("error").textContent = "";
    document.getElementById("resultsCard").style.display = "none";
    setMode("standard");
  });

  // Initialize mode
  setMode("standard");
</script>
</body>
</html>
